.PHONY: up down destroy ssh-server ssh-worker kubeconfig status clean

# Start the K3s cluster
up:
	@echo "ğŸš€ Starting K3s cluster..."
	@echo "â³ This might take a few minutes..."
	vagrant up
	@echo "âœ… Cluster is up and running!"

# Stop the K3s cluster
down:
	@echo "ğŸ›‘ Stopping K3s cluster..."
	vagrant halt
	@echo "ğŸ’¤ Cluster is now stopped"

# Destroy the K3s cluster
destroy:
	@echo "ğŸ’¥ Destroying K3s cluster..."
	vagrant destroy -f
	@echo "ğŸ—‘ï¸  Cluster has been destroyed"

# SSH into the server node
ssh-server:
	@echo "ğŸ”‘ Connecting to server node..."
	vagrant ssh hahadiouS

# SSH into the worker node
ssh-worker:
	@echo "ğŸ”‘ Connecting to worker node..."
	vagrant ssh hahadiouSW

# Get kubeconfig
kubeconfig:
	@echo "ğŸ“‹ Getting kubeconfig..."
	vagrant ssh hahadiouS -c "cat /home/vagrant/.kube/config" > kubeconfig.yaml
	@echo "âœ… Kubeconfig saved to kubeconfig.yaml"

# Check cluster status
status:
	@echo "ğŸ“Š Checking cluster status..."
	@echo "ğŸŒ Nodes:"
	vagrant ssh hahadiouS -c "sudo kubectl get nodes"
	@echo "\nğŸ“¦ Pods:"
	vagrant ssh hahadiouS -c "sudo kubectl get pods -A"

# Clean everything
clean:
	@echo "ğŸ§¹ Cleaning up everything..."
	@if [ -f kubeconfig.yaml ]; then \
		rm kubeconfig.yaml; \
		echo "ğŸ—‘ï¸  Removed kubeconfig.yaml"; \
	fi
	@if [ -d .vagrant ]; then \
		vagrant destroy -f; \
		echo "ğŸ’¥ Destroyed Vagrant environment"; \
	fi
	@echo "âœ¨ Cleanup complete!"

# Help command
help:
	@echo "ğŸ¤– Available commands:"
	@echo "  make up         ğŸš€ Start the K3s cluster"
	@echo "  make down       ğŸ›‘ Stop the K3s cluster"
	@echo "  make destroy    ğŸ’¥ Destroy the K3s cluster"
	@echo "  make ssh-server ğŸ”‘ SSH into the server node"
	@echo "  make ssh-worker ğŸ”‘ SSH into the worker node"
	@echo "  make kubeconfig ğŸ“‹ Get the kubeconfig file"
	@echo "  make status     ğŸ“Š Check cluster and pods status"
	@echo "  make clean      ğŸ§¹ Remove all generated files and destroy environment"
