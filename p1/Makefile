.PHONY: up down destroy ssh-server ssh-worker kubeconfig status clean verify scripts

# Make scripts executable
scripts:
	@echo "ğŸ”§ Making scripts executable..."
	chmod +x scripts/*.sh
	@echo "âœ… Scripts are now executable"

# Generate SSH keys
ssh-keys:
	@echo "ğŸ”‘ Generating SSH keys..."
	./scripts/generate_ssh_keys.sh
	@echo "âœ… SSH keys generated!"

# Start the K3s cluster
up: scripts ssh-keys
	@echo "ğŸš€ Starting K3s cluster..."
	@echo "â³ This might take a few minutes..."
	vagrant up
	@echo "âœ… Cluster is up and running!"

# Stop the K3s cluster
down:
	@echo "ğŸ›‘ Stopping K3s cluster..."
	vagrant halt
	@echo "ğŸ’¤ Cluster is now stopped"

# Destroy the K3s cluster
destroy:
	@echo "ğŸ’¥ Destroying K3s cluster..."
	vagrant destroy -f
	@echo "ğŸ—‘ï¸  Cluster has been destroyed"

# SSH into the server node
ssh-server:
	@echo "ğŸ”‘ Connecting to server node..."
	vagrant ssh hahadiouS

# SSH into the worker node
ssh-worker:
	@echo "ğŸ”‘ Connecting to worker node..."
	vagrant ssh hahadiouSW

# Get kubeconfig
kubeconfig:
	@echo "ğŸ“‹ Getting kubeconfig..."
	vagrant ssh hahadiouS -c "cat /home/vagrant/.kube/config" > kubeconfig.yaml
	@echo "âœ… Kubeconfig saved to kubeconfig.yaml"

# Check cluster status
status:
	@echo "ğŸ“Š Checking cluster status..."
	@echo "ğŸŒ Nodes:"
	vagrant ssh hahadiouS -c "sudo kubectl get nodes"
	@echo "\nğŸ“¦ Pods:"
	vagrant ssh hahadiouS -c "sudo kubectl get pods -A"

# Verify everything is working properly
verify:
	@echo "ğŸ” Starting verification process..."
	@echo "\n1ï¸âƒ£ Checking VM status..."
	@vagrant status
	@echo "\n2ï¸âƒ£ Verifying network connectivity..."
	@echo "   Server IP (192.168.56.110):"
	@vagrant ssh hahadiouS -c "ip a show eth1 | grep inet"
	@echo "   Worker IP (192.168.56.111):"
	@vagrant ssh hahadiouSW -c "ip a show eth1 | grep inet"
	@echo "\n3ï¸âƒ£ Testing passwordless SSH..."
	@echo "   Testing server to worker:"
	@vagrant ssh hahadiouS -c "ssh -i /home/vagrant/.ssh/id_rsa -o StrictHostKeyChecking=no vagrant@192.168.56.111 'echo âœ… SSH test successful'"
	@echo "   Testing worker to server:"
	@vagrant ssh hahadiouSW -c "ssh -i /home/vagrant/.ssh/id_rsa -o StrictHostKeyChecking=no vagrant@192.168.56.110 'echo âœ… SSH test successful'"
	@echo "\n4ï¸âƒ£ Checking K3s installation..."
	@echo "   Server K3s status:"
	@vagrant ssh hahadiouS -c "sudo systemctl status k3s"
	@echo "   Worker K3s status:"
	@vagrant ssh hahadiouSW -c "sudo systemctl status k3s-agent"
	@echo "\n5ï¸âƒ£ Verifying Kubernetes cluster..."
	@echo "   Nodes:"
	@vagrant ssh hahadiouS -c "sudo kubectl get nodes -o wide"
	@echo "\n   All pods:"
	@vagrant ssh hahadiouS -c "sudo kubectl get pods -A"
	@echo "\n   System pods:"
	@vagrant ssh hahadiouS -c "sudo kubectl get pods -n kube-system"
	@echo "\nâœ… Verification complete!"

# Clean everything
clean:
	@echo "ğŸ§¹ Cleaning up everything..."
	@if [ -f kubeconfig.yaml ]; then \
		rm kubeconfig.yaml; \
		echo "ğŸ—‘ï¸  Removed kubeconfig.yaml"; \
	fi
	@if [ -d .vagrant ]; then \
		vagrant destroy -f; \
		echo "ğŸ’¥ Destroyed Vagrant environment"; \
	fi
	@echo "âœ¨ Cleanup complete!"

# Help command
help:
	@echo "ğŸ¤– Available commands:"
	@echo "  make up         ğŸš€ Start the K3s cluster"
	@echo "  make down       ğŸ›‘ Stop the K3s cluster"
	@echo "  make destroy    ğŸ’¥ Destroy the K3s cluster"
	@echo "  make ssh-server ğŸ”‘ SSH into the server node"
	@echo "  make ssh-worker ğŸ”‘ SSH into the worker node"
	@echo "  make kubeconfig ğŸ“‹ Get the kubeconfig file"
	@echo "  make status     ğŸ“Š Check cluster and pods status"
	@echo "  make verify     ğŸ” Verify all components are working"
	@echo "  make clean      ğŸ§¹ Remove all generated files and destroy environment"
