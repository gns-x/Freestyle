Vagrant.configure("2") do |config|
  # Use Ubuntu 22.04 LTS as the base box
  config.vm.box = "bento/ubuntu-22.04"
  
  # Configure VMware provider
  config.vm.provider "vmware_desktop" do |v|
    v.gui = false
    v.memory = 1024
    v.cpus = 1
  end

  # Configure the K3s server node
  config.vm.define "hahadiouS" do |server|
    server.vm.hostname = "hahadiouS"
    server.vm.network "private_network", ip: "192.168.56.110"
    
    # Provisioning script for the server
    server.vm.provision "shell", inline: <<-SHELL
      # Update system
      apt-get update
      apt-get upgrade -y
      
      # Install required packages
      apt-get install -y curl wget
      
      # Install K3s server
      curl -sfL https://get.k3s.io | sh -s - server --cluster-init
      
      # Get kubeconfig
      mkdir -p /home/vagrant/.kube
      cp /etc/rancher/k3s/k3s.yaml /home/vagrant/.kube/config
      chown vagrant:vagrant /home/vagrant/.kube/config
      
      # Set up passwordless SSH
      mkdir -p /home/vagrant/.ssh
      chmod 700 /home/vagrant/.ssh
      cp /vagrant/confs/id_rsa.pub /home/vagrant/.ssh/authorized_keys
      chmod 600 /home/vagrant/.ssh/authorized_keys
      chown -R vagrant:vagrant /home/vagrant/.ssh
    SHELL
  end

  # Configure the K3s worker node
  config.vm.define "hahadiouSW" do |worker|
    worker.vm.hostname = "hahadiouSW"
    worker.vm.network "private_network", ip: "192.168.56.111"
    
    # Provisioning script for the worker
    worker.vm.provision "shell", inline: <<-SHELL
      # Update system
      apt-get update
      apt-get upgrade -y
      
      # Install required packages
      apt-get install -y curl wget
      
      # Wait for server to be ready and get token
      until curl -k -s https://192.168.56.110:6443 >/dev/null; do
        sleep 5
      done
      
      # Get token from server
      TOKEN=$(ssh -o StrictHostKeyChecking=no vagrant@192.168.56.110 "sudo cat /var/lib/rancher/k3s/server/node-token")
      
      # Install K3s agent
      curl -sfL https://get.k3s.io | K3S_URL=https://192.168.56.110:6443 K3S_TOKEN=$TOKEN sh -
      
      # Set up passwordless SSH
      mkdir -p /home/vagrant/.ssh
      chmod 700 /home/vagrant/.ssh
      cp /vagrant/confs/id_rsa.pub /home/vagrant/.ssh/authorized_keys
      chmod 600 /home/vagrant/.ssh/authorized_keys
      chown -R vagrant:vagrant /home/vagrant/.ssh
    SHELL
  end
end
