Vagrant.configure("2") do |config|
  # Use Ubuntu as the base box
  config.vm.box = "ubuntu/jammy64"

  
  # Disable the default synced folder
  config.vm.synced_folder ".", "/vagrant", disabled: true
  
  # Configure the first machine (Server)
  config.vm.define "hahadiouS" do |control|
    control.vm.hostname = "hahadiouS"
    control.vm.network "private_network", ip: "192.168.56.110"
    
    # Set VM resources
    control.vm.provider "virtualbox" do |v|
      v.name = "hahadiouS"
      v.memory = 1024
      v.cpus = 1
      v.customize ["modifyvm", :id, "--ioapic", "on"]
      v.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
      v.customize ["modifyvm", :id, "--natdnsproxy1", "on"]
      v.customize ["modifyvm", :id, "--uart1", "off"]
      v.customize ["modifyvm", :id, "--uart2", "off"]
      v.customize ["modifyvm", :id, "--uart3", "off"]
      v.customize ["modifyvm", :id, "--uart4", "off"]
      v.customize ["modifyvm", :id, "--uartmode1", "disconnected"]
      # Disable USB
      v.customize ["modifyvm", :id, "--usb", "off"]
      v.customize ["modifyvm", :id, "--usbehci", "off"]
    end
    
    # Create a separate synced folder with minimal permissions
    control.vm.synced_folder ".", "/vagrant", 
      owner: "vagrant",
      group: "vagrant",
      mount_options: ["dmode=755,fmode=644"]
    
    # Provisioning script for the server
    control.vm.provision "shell", inline: <<-SHELL
      # Update system
      apt-get update
      apt-get upgrade -y
      
      # Install required packages
      apt-get install -y curl wget
      
      # Install K3s server
      curl -sfL https://get.k3s.io | sh -s - server --node-ip 192.168.56.110
      
      # Install kubectl
      curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
      chmod +x kubectl
      mv kubectl /usr/local/bin/
      
      # Configure kubectl
      mkdir -p /root/.kube
      cp /etc/rancher/k3s/k3s.yaml /root/.kube/config
      sed -i 's/127.0.0.1/192.168.56.110/g' /root/.kube/config
      
      # Get the node token for worker node
      cat /var/lib/rancher/k3s/server/node-token > /vagrant/node-token
    SHELL
  end
  
  # Configure the second machine (ServerWorker)
  config.vm.define "hahadiouSW" do |worker|
    worker.vm.hostname = "hahadiouSW"
    worker.vm.network "private_network", ip: "192.168.56.111"
    
    # Set VM resources
    worker.vm.provider "virtualbox" do |v|
      v.name = "hahadiouSW"
      v.memory = 1024
      v.cpus = 1
      v.customize ["modifyvm", :id, "--ioapic", "on"]
      v.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
      v.customize ["modifyvm", :id, "--natdnsproxy1", "on"]
      v.customize ["modifyvm", :id, "--uart1", "off"]
      v.customize ["modifyvm", :id, "--uart2", "off"]
      v.customize ["modifyvm", :id, "--uart3", "off"]
      v.customize ["modifyvm", :id, "--uart4", "off"]
      v.customize ["modifyvm", :id, "--uartmode1", "disconnected"]
      # Disable USB
      v.customize ["modifyvm", :id, "--usb", "off"]
      v.customize ["modifyvm", :id, "--usbehci", "off"]
    end
    
    # Create a separate synced folder with minimal permissions
    worker.vm.synced_folder ".", "/vagrant", 
      owner: "vagrant",
      group: "vagrant",
      mount_options: ["dmode=755,fmode=644"]
    
    # Provisioning script for the worker
    worker.vm.provision "shell", inline: <<-SHELL
      # Update system
      apt-get update
      apt-get upgrade -y
      
      # Install required packages
      apt-get install -y curl wget
      
      # Wait for the server to be ready and get the token
      while [ ! -f /vagrant/node-token ]; do
        sleep 1
      done
      
      # Install K3s agent
      curl -sfL https://get.k3s.io | K3S_URL=https://192.168.56.110:6443 K3S_TOKEN=$(cat /vagrant/node-token) sh -
    SHELL
  end
end
