.PHONY: up down destroy ssh status verify clean scripts logs restart-apps

# Make scripts executable
scripts:
	@echo "ğŸ”§ Making scripts executable..."
	@chmod +x scripts/*.sh
	@echo "âœ… Scripts are now executable"

# Start the VM and deploy applications
up: scripts
	@echo "ğŸš€ Starting VM and deploying applications..."
	@echo "â³ This might take a few minutes..."
	@vagrant up || (echo "âŒ Failed to start VM. Please check the Vagrantfile and try again." && exit 1)
	@echo "âœ… VM is up and running!"
	@echo "ğŸ“¦ Deploying applications..."
	@vagrant ssh hahadiouS -c "cd /vagrant && ./scripts/apply_configs.sh" || (echo "âŒ Failed to deploy applications. Please check the logs and try again." && exit 1)
	@echo "âœ… Applications deployed successfully!"
	@echo "ğŸ“ Add these entries to your /etc/hosts file:"
	@echo "192.168.56.110 app1.com"
	@echo "192.168.56.110 app2.com"
	@echo "192.168.56.110 app3.com"

# Stop the VM
down:
	@echo "ğŸ›‘ Stopping VM..."
	@vagrant halt || (echo "âŒ Failed to stop VM." && exit 1)
	@echo "ğŸ’¤ VM is now stopped"

# Destroy the VM
destroy:
	@echo "ğŸ’¥ Destroying VM..."
	@vagrant destroy -f || (echo "âŒ Failed to destroy VM." && exit 1)
	@echo "ğŸ—‘ï¸  VM has been destroyed"

# SSH into the VM
ssh:
	@echo "ğŸ”‘ Connecting to VM..."
	@vagrant ssh hahadiouS || (echo "âŒ Failed to connect to VM. Is it running?" && exit 1)

# Check cluster status
status:
	@echo "ğŸ“Š Checking cluster status..."
	@echo "ğŸŒ Nodes:"
	@vagrant ssh hahadiouS -c "sudo kubectl get nodes" || (echo "âŒ Failed to get nodes status." && exit 1)
	@echo "\nğŸ“¦ Deployments:"
	@vagrant ssh hahadiouS -c "sudo kubectl get deployments" || (echo "âŒ Failed to get deployments status." && exit 1)
	@echo "\nğŸ“¦ Pods:"
	@vagrant ssh hahadiouS -c "sudo kubectl get pods" || (echo "âŒ Failed to get pods status." && exit 1)
	@echo "\nğŸŒ Services:"
	@vagrant ssh hahadiouS -c "sudo kubectl get services" || (echo "âŒ Failed to get services status." && exit 1)
	@echo "\nğŸŒ Ingress:"
	@vagrant ssh hahadiouS -c "sudo kubectl get ingress" || (echo "âŒ Failed to get ingress status." && exit 1)

# Show application logs
logs:
	@echo "ğŸ“œ Showing application logs..."
	@echo "\nğŸ“ App1 logs:"
	@vagrant ssh hahadiouS -c "sudo kubectl logs -l app=app1" || (echo "âŒ Failed to get App1 logs." && exit 1)
	@echo "\nğŸ“ App2 logs:"
	@vagrant ssh hahadiouS -c "sudo kubectl logs -l app=app2" || (echo "âŒ Failed to get App2 logs." && exit 1)
	@echo "\nğŸ“ App3 logs:"
	@vagrant ssh hahadiouS -c "sudo kubectl logs -l app=app3" || (echo "âŒ Failed to get App3 logs." && exit 1)

# Restart applications
restart-apps:
	@echo "ğŸ”„ Restarting applications..."
	@vagrant ssh hahadiouS -c "cd /vagrant && ./scripts/apply_configs.sh" || (echo "âŒ Failed to restart applications." && exit 1)
	@echo "âœ… Applications restarted successfully!"

# Verify everything is working properly
verify:
	@echo "ğŸ” Starting verification process..."
	@echo "\n1ï¸âƒ£ Checking VM status..."
	@vagrant status || (echo "âŒ Failed to get VM status." && exit 1)
	@echo "\n2ï¸âƒ£ Verifying network connectivity..."
	@echo "   VM IP (192.168.56.110):"
	@vagrant ssh hahadiouS -c "ip a show eth1 | grep inet" || (echo "âŒ Failed to get network information." && exit 1)
	@echo "\n3ï¸âƒ£ Checking K3s installation..."
	@echo "   K3s status:"
	@vagrant ssh hahadiouS -c "sudo systemctl status k3s" || (echo "âŒ Failed to get K3s status." && exit 1)
	@echo "\n4ï¸âƒ£ Verifying Kubernetes cluster..."
	@echo "   Nodes:"
	@vagrant ssh hahadiouS -c "sudo kubectl get nodes -o wide" || (echo "âŒ Failed to get nodes information." && exit 1)
	@echo "\n   All pods:"
	@vagrant ssh hahadiouS -c "sudo kubectl get pods -A" || (echo "âŒ Failed to get pods information." && exit 1)
	@echo "\n   System pods:"
	@vagrant ssh hahadiouS -c "sudo kubectl get pods -n kube-system" || (echo "âŒ Failed to get system pods information." && exit 1)
	@echo "\n5ï¸âƒ£ Checking Ingress Controller..."
	@echo "   Ingress controller status:"
	@vagrant ssh hahadiouS -c "sudo kubectl get pods -n ingress-nginx" || (echo "âŒ Failed to get ingress controller status." && exit 1)
	@echo "\n6ï¸âƒ£ Verifying Applications..."
	@echo "   App1 deployment:"
	@vagrant ssh hahadiouS -c "sudo kubectl get deployment app1" || (echo "âŒ Failed to get App1 deployment status." && exit 1)
	@echo "   App2 deployment:"
	@vagrant ssh hahadiouS -c "sudo kubectl get deployment app2" || (echo "âŒ Failed to get App2 deployment status." && exit 1)
	@echo "   App3 deployment:"
	@vagrant ssh hahadiouS -c "sudo kubectl get deployment app3" || (echo "âŒ Failed to get App3 deployment status." && exit 1)
	@echo "\n7ï¸âƒ£ Checking Ingress Configuration..."
	@echo "   Ingress rules:"
	@vagrant ssh hahadiouS -c "sudo kubectl get ingress apps-ingress -o yaml | grep -A 10 'rules:'" || (echo "âŒ Failed to get ingress rules." && exit 1)
	@echo "\n8ï¸âƒ£ Testing Application Access..."
	@echo "   Testing App1..."
	@vagrant ssh hahadiouS -c "curl -s -H 'Host: app1.com' http://localhost" || (echo "âŒ Failed to access App1." && exit 1)
	@echo "   Testing App2..."
	@vagrant ssh hahadiouS -c "curl -s -H 'Host: app2.com' http://localhost" || (echo "âŒ Failed to access App2." && exit 1)
	@echo "   Testing App3..."
	@vagrant ssh hahadiouS -c "curl -s -H 'Host: app3.com' http://localhost" || (echo "âŒ Failed to access App3." && exit 1)
	@echo "\nâœ… Verification complete!"

# Clean everything
clean:
	@echo "ğŸ§¹ Cleaning up everything..."
	@if [ -d .vagrant ]; then \
		vagrant destroy -f || (echo "âŒ Failed to destroy VM." && exit 1); \
		echo "ğŸ’¥ Destroyed Vagrant environment"; \
	fi
	@echo "âœ¨ Cleanup complete!"

# Help command
help:
	@echo "ğŸ¤– Available commands:"
	@echo "  make up           ğŸš€ Start VM and deploy applications"
	@echo "  make down         ğŸ›‘ Stop the VM"
	@echo "  make destroy      ğŸ’¥ Destroy the VM"
	@echo "  make ssh          ğŸ”‘ SSH into the VM"
	@echo "  make status       ğŸ“Š Check cluster and applications status"
	@echo "  make logs         ğŸ“œ Show application logs"
	@echo "  make restart-apps ğŸ”„ Restart all applications"
	@echo "  make verify       ğŸ” Verify all components are working"
	@echo "  make clean        ğŸ§¹ Remove all generated files and destroy environment" 